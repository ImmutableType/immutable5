# EIP-6963 Implementation Guide

This document explains how EIP-6963 wallet discovery is implemented in ImmutableType and how to work with it.

## What is EIP-6963?

EIP-6963 (Multi Injected Provider Discovery) is a standard that allows dApps to discover multiple injected wallet providers. This solves the problem of multiple wallets being installed and conflicting with each other.

### The Problem It Solves

Before EIP-6963:
- Only `window.ethereum` was the standard
- When multiple wallets were installed, they would overwrite each other
- dApps couldn't reliably detect which wallets were available

After EIP-6963:
- Wallets announce themselves via events
- dApps can discover all available wallets
- No conflicts between wallet providers

## Implementation Overview

### Core Files

- `lib/web3/eip6963.ts` - Core EIP-6963 implementation
- `lib/web3/eip6963Initializer.tsx` - React component for initialization
- `lib/hooks/useUnifiedWallet.ts` - Uses EIP-6963 for wallet discovery

### Architecture

```
EIP6963Initializer (app/layout.tsx)
    ↓
initEIP6963Discovery()
    ↓
Event Listener: 'eip6963:announceProvider'
    ↓
Provider Registry (Map<RDNS, ProviderDetail>)
    ↓
useUnifiedWallet Hook
    ↓
WalletSelector Component
```

## How It Works

### 1. Initialization

EIP-6963 discovery is initialized early in the app lifecycle:

```typescript
// app/layout.tsx
import { EIP6963Initializer } from '../lib/web3/eip6963Initializer'

export default function RootLayout({ children }) {
  return (
    <html>
      <body>
        <EIP6963Initializer /> {/* Initializes discovery */}
        {children}
      </body>
    </html>
  )
}
```

### 2. Discovery Process

```typescript
// lib/web3/eip6963.ts

// Listen for wallet announcements
window.addEventListener('eip6963:announceProvider', onAnnounceProvider)

// Request wallets to announce themselves
window.dispatchEvent(new Event('eip6963:requestProvider'))
```

### 3. Provider Registry

Discovered providers are stored in a Map:

```typescript
const discoveredProviders = new Map<string, EIP6963ProviderDetail>()

function onAnnounceProvider(event: Event) {
  const { info, provider } = event.detail
  // Store by RDNS (Reverse Domain Name Service identifier)
  discoveredProviders.set(info.rdns, { info, provider })
}
```

## RDNS Identifiers

RDNS (Reverse Domain Name Service) identifiers uniquely identify wallet providers:

| Wallet | RDNS Identifier |
|--------|----------------|
| MetaMask | `io.metamask` |
| Flow Wallet | `com.flowfoundation.wallet` |
| Coinbase Wallet | `com.coinbase.wallet` |

## API Reference

### Core Functions

#### `initEIP6963Discovery()`
Initializes EIP-6963 discovery. Should be called once on app load.

```typescript
import { initEIP6963Discovery } from '@/lib/web3/eip6963'

initEIP6963Discovery()
```

#### `getFlowWalletProvider()`
Gets Flow Wallet provider if available.

```typescript
import { getFlowWalletProvider } from '@/lib/web3/eip6963'

const provider = getFlowWalletProvider()
if (provider) {
  // Use Flow Wallet
}
```

#### `getMetaMaskProvider()`
Gets MetaMask provider if available.

```typescript
import { getMetaMaskProvider } from '@/lib/web3/eip6963'

const provider = getMetaMaskProvider()
```

#### `isFlowWalletAvailable()`
Checks if Flow Wallet is available.

```typescript
import { isFlowWalletAvailable } from '@/lib/web3/eip6963'

if (isFlowWalletAvailable()) {
  // Show Flow Wallet option
}
```

#### `getAllProviders()`
Gets all discovered providers.

```typescript
import { getAllProviders } from '@/lib/web3/eip6963'

const providers = getAllProviders()
// Returns: EIP6963ProviderDetail[]
```

#### `getProviderByRDNS(rdns)`
Gets a specific provider by RDNS.

```typescript
import { getProviderByRDNS } from '@/lib/web3/eip6963'

const provider = getProviderByRDNS('com.flowfoundation.wallet')
```

## Type Definitions

```typescript
interface EIP6963ProviderInfo {
  uuid: string        // Unique identifier (changes each session)
  name: string       // Wallet name (e.g., "Flow Wallet")
  icon: string       // Base64 encoded icon
  rdns: string       // Reverse DNS identifier (stable)
}

interface EIP1193Provider {
  request: (args: { method: string; params?: unknown[] }) => Promise<unknown>
  on?: (event: string, handler: (...args: unknown[]) => void) => void
  removeListener?: (event: string, handler: (...args: unknown[]) => void) => void
}

interface EIP6963ProviderDetail {
  info: EIP6963ProviderInfo
  provider: EIP1193Provider
}
```

## Usage Examples

### Checking Wallet Availability

```typescript
import { isFlowWalletAvailable, isMetaMaskAvailable } from '@/lib/web3/eip6963'

const availableWallets = {
  metamask: isMetaMaskAvailable(),
  flowWallet: isFlowWalletAvailable()
}
```

### Connecting to a Specific Wallet

```typescript
import { getFlowWalletProvider } from '@/lib/web3/eip6963'
import { ethers } from 'ethers'

const flowProvider = getFlowWalletProvider()
if (flowProvider) {
  // Request account access
  const accounts = await flowProvider.request({ 
    method: 'eth_requestAccounts' 
  })
  
  // Create ethers provider
  const browserProvider = new ethers.BrowserProvider(flowProvider)
}
```

### Getting All Available Wallets

```typescript
import { getAllProviders } from '@/lib/web3/eip6963'

const providers = getAllProviders()
providers.forEach(provider => {
  console.log(`Found wallet: ${provider.info.name} (${provider.info.rdns})`)
})
```

## Integration with Unified Wallet

The `useUnifiedWallet` hook uses EIP-6963 internally:

```typescript
// lib/hooks/useUnifiedWallet.ts

const connectFlowWallet = async () => {
  // Initialize discovery
  const { initEIP6963Discovery } = await import('../web3/eip6963')
  initEIP6963Discovery()
  
  // Wait for announcements
  await new Promise(resolve => setTimeout(resolve, 500))
  
  // Get Flow Wallet provider
  const flowProvider = getFlowWalletProvider()
  if (!flowProvider) {
    throw new Error('Flow Wallet not available')
  }
  
  // Connect...
}
```

## Timing Considerations

Wallets may announce themselves at different times:

1. **Immediate**: Some wallets announce immediately
2. **Delayed**: Some wallets need time to load
3. **Multiple Requests**: We request multiple times to catch late announcements

### Retry Strategy

```typescript
// Try multiple times with delays
for (let i = 0; i < 5; i++) {
  await new Promise(resolve => setTimeout(resolve, 300))
  const provider = getFlowWalletProvider()
  if (provider) break
}
```

## Debugging

### Enable Debug Logging

The implementation logs all wallet announcements:

```
[EIP-6963] Wallet announced: MetaMask (io.metamask)
[EIP-6963] Wallet announced: Flow Wallet (com.flowfoundation.wallet)
[EIP-6963] Discovery initialized
```

### Check Discovered Providers

```typescript
import { getAllProviders } from '@/lib/web3/eip6963'

const providers = getAllProviders()
console.log('Discovered wallets:', providers.map(p => p.info.name))
```

### Browser Console

```javascript
// Check if discovery is working
window.dispatchEvent(new Event('eip6963:requestProvider'))

// Check for announcements
window.addEventListener('eip6963:announceProvider', (e) => {
  console.log('Wallet announced:', e.detail.info.name)
})
```

## Common Issues

### Wallet Not Detected

**Problem**: Wallet installed but not detected

**Solutions**:
1. Check if wallet supports EIP-6963
2. Refresh the page
3. Check browser console for errors
4. Verify wallet extension is enabled

### Multiple Announcements

**Problem**: Same wallet announces multiple times

**Solution**: We store by RDNS, so duplicates are handled automatically

### Late Announcements

**Problem**: Wallet announces after initial check

**Solution**: We request providers multiple times (0ms, 1s, 3s)

## Adding Support for New Wallets

1. **Find RDNS**: Check wallet documentation for RDNS identifier
2. **Add to Constants**:
   ```typescript
   export const WALLET_RDNS = {
     NEW_WALLET: 'com.newwallet.rdns'
   }
   ```
3. **Add Detection Function**:
   ```typescript
   export function getNewWalletProvider(): EIP1193Provider | null {
     const detail = discoveredProviders.get(WALLET_RDNS.NEW_WALLET)
     return detail?.provider || null
   }
   ```
4. **Update Unified Wallet**: Add connection logic in `useUnifiedWallet.ts`

## Testing

### Test with Multiple Wallets

1. Install both MetaMask and Flow Wallet
2. Check console for announcements
3. Verify both wallets are detected
4. Test connection with each wallet

### Test Wallet Detection

```typescript
import { initEIP6963Discovery, getAllProviders } from '@/lib/web3/eip6963'

// Initialize
initEIP6963Discovery()

// Wait a bit
setTimeout(() => {
  const providers = getAllProviders()
  console.log('Detected wallets:', providers.length)
}, 2000)
```

## Further Reading

- [EIP-6963 Specification](https://eips.ethereum.org/EIPS/eip-6963)
- [EIP-1193 Provider Standard](https://eips.ethereum.org/EIPS/eip-1193)
- [Flow Wallet Documentation](https://docs.onflow.org/wallet/)
